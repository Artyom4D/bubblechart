/**
 * BubbleChart (0.0.0-dev)
 *
 * Author: Jonathan D. Johnson (http://jondavidjohn.com)
 * Homepage: https://github.com/jondavidjohn/bubblechart
 * Issue Tracker: https://github.com/jondavidjohn/bubblechart/issues
 * License: Apache 2.0
 */
(function(){this.BubbleChart=function(){function a(b){var c,d,e,f=this;this.o=b,this.data=b.data||[],this.metric=b.metric,this.fillColors=b.fillColors||[],this.fps=b.fps||60,this.contain=b.contain||!1,this.gutter=b.gutter||0,this.canvas=document.getElementById(b.canvasId),null==b.attribution&&(b.attribution="before"),b.attribution&&(e="https://github.com/jondavidjohn/bubblechart",c=document.createElement("div"),c.className="bubblechart-attribution",c.innerHTML='<small>(Powered by <a href="'+e+'">BubbleChart</a>)</small>',"before"===b.attribution&&this.canvas.parentNode.insertBefore(c,this.canvas),"after"===b.attribution&&this.canvas.parentNode.insertBefore(c,this.canvas.nextSibling)),d=document.createComment(" BubbleChart by jondavidjohn (http://jondavidjohn.github.io/bubblechart/) "),null!=this.canvas.firstChild?this.canvas.insertBefore(d,this.canvas.firstChild):this.canvas.appendChild(d),this.pointer=new a.Pointer,function(c){var d;return c.context=c.getContext("2d"),d=1,null!=window.devicePixelRatio&&window.devicePixelRatio>1&&c.context.webkitBackingStorePixelRatio<2&&(d=window.devicePixelRatio),d>1&&(c.style.height=""+c.height+"px",c.style.width=""+c.width+"px",c.width=c.width*d,c.height=c.height*d),c.style.position="relative",c.onmousemove=c.ontouchmove=f.pointer.e_move,c.onmousedown=c.ontouchstart=f.pointer.e_grab,c.onmouseup=c.onmouseout=c.ontouchend=f.pointer.e_release,c.style.webkitUserSelect="none",c.area=c.height*c.width,c.usableArea=c.area*(b.usedArea||.2),c.midpoint=new a.Point(c.width/2,c.height/2)}(this.canvas),this.data.length&&this.reload()}return a.prototype.reload=function(){var b,c,d,e,f,g,h;for(this.bubbles=[],this.metricTotal=function(){var a,c,d,e;for(d=this.data,e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(b.data);return e}.call(this).reduce(function(a,b){return a+b}),g=this.data,h=[],e=0,f=g.length;f>e;e++)b=g[e],d=function(a){return a[a.length?Math.randInt(a.length):void 0]}(this.fillColors),c={href:b.href,label:b.label,metric:b.metric||this.o.metric,data:b.data,fillColor:b.fillColor||d,borderColor:b.borderColor||this.o.borderColor,textColor:b.textColor||this.o.textColor,textFont:b.textFont||this.o.textFont,borderSize:b.borderSize||this.o.borderSize,radius:Math.sqrt(this.canvas.usableArea*(b.data/this.metricTotal))/2,popoverOpts:this.o.popoverOpts,position:new a.Point(Math.randInt(Math.sqrt(this.canvas.area)),Math.randInt(Math.sqrt(this.canvas.area))),pointOfGravity:this.canvas.midpoint},h.push(this.bubbles.push(new a.Bubble(c)));return h},a.prototype.paint=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this;for(null==a&&(a=!0),j=this.bubbles,d=0,g=j.length;g>d;d++)for(b=j[d],b.advance(this),k=this.bubbles,e=0,h=k.length;h>e;e++)c=k[e],b.label!==c.label&&b.overlapsWith(c)&&b.resolveCollisionWith(c),this.contain&&c.pushAwayFromEdges(this.canvas,this.gutter);for(this.canvas.context.clearRect(0,0,this.canvas.width,this.canvas.height),null!=this.pointer.bubble&&(this.pointer.bubble.grabbed||(document.body.style.cursor="default"),this.pointer.bubble.grabbed||(this.pointer.bubble=null)),l=this.bubbles,f=0,i=l.length;i>f;f++)b=l[f],b.paint(this.canvas.context),null==this.pointer.current||this.pointer.grabbingBubble()||this.canvas.context.isPointInPath(this.pointer.current.x,this.pointer.current.y)&&(this.pointer.bubble=b);return null!=this.pointer.bubble&&(document.body.style.cursor="pointer",this.pointer.bubble.popover.paint(this.pointer,this.canvas.context)),a?setTimeout(function(){return m.paint()},1e3/this.fps):void 0},a}()}).call(this),function(){BubbleChart.Bubble=function(){function a(a){this.grabbed=!1,this.bully=!1,this.pointOfGravity=a.pointOfGravity,this.href=a.href,this.label=a.label,this.metric=a.metric,this.data=a.data,this.fillColor=a.fillColor,this.borderColor=a.borderColor,this.textColor=a.textColor,this.textFont=a.textFont||"helvetica",this.borderSize=a.borderSize,this.radius=a.radius,this.position=a.position,this.diameter=2*this.radius,this.reach=this.radius,null!=this.borderSize&&(this.reach+=this.borderSize),this.popover=new BubbleChart.Popover(this,a.popoverOpts||{})}return a.prototype.getVelocity=function(){return{x:.04*(this.pointOfGravity.x-this.position.x),y:.04*(this.pointOfGravity.y-this.position.y)}},a.prototype.advance=function(a){var b,c;return this.grabbed?(b=a.pointer,null!=b.current&&null!=b.diff?(this.position.x=b.current.x-b.diff.x,this.position.y=b.current.y-b.diff.y):void 0):(c=this.getVelocity(),this.position.x+=c.x,this.position.y+=c.y)},a.prototype.distanceFrom=function(a){return this.position.distance(a.position)-(this.reach+a.reach)},a.prototype.overlapsWith=function(a){return this.distanceFrom(a)<0},a.prototype.hasSpatialInferiorityTo=function(a){return a.grabbed||a.radius>this.radius&&!this.grabbed||a.radius>this.radius&&this.bully&&a.bully&&!this.grabbed||a.bully&&!this.grabbed},a.prototype.resolveCollisionWith=function(a){var b,c,d,e;return this.overlapsWith(a)?(b=this.position.distance(a.position),c=this.distanceFrom(a),e=b-c,this.hasSpatialInferiorityTo(a)?(d=this.position.rAngle(a.position),this.position.x=a.position.x+e*Math.cos(d),this.position.y=a.position.y+e*Math.sin(d),this.bully=!0):(d=a.position.rAngle(this.position),a.position.x=this.position.x+e*Math.cos(d),a.position.y=this.position.y+e*Math.sin(d),a.bully=!0)):void 0},a.prototype.pushAwayFromEdges=function(a,b){return this.position.y-this.reach+b<0?(this.position.y=this.reach-b,this.bully=!0):this.position.y+this.reach-b>a.height?(this.position.y=a.height-this.reach+b,this.bully=!0):this.position.x+this.reach-b>a.width?(this.position.x=a.width-this.reach+b,this.bully=!0):this.position.x-this.reach+b<0?(this.position.x=this.reach-b,this.bully=!0):void 0},a.prototype.paint=function(a){var b,c,d,e;if(a.beginPath(),a.fillStyle=this.fillColor,a.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI,!0),a.fill(),null!=this.borderColor&&(a.lineWidth=this.borderSize,a.strokeStyle=this.borderColor,a.stroke()),this.textColor)if(a.font="20px '"+this.textFont+"'",a.fillStyle=this.textColor,d=a.measureText(this.label),d.width+12<this.diameter)b=this.position.x-d.width/2,c=this.position.y+7,a.fillText(this.label,b,c);else if(a.font="12px helvetica",d=a.measureText(this.label),d.width+7<this.diameter)b=this.position.x-d.width/2,c=this.position.y+2,a.fillText(this.label,b,c);else{for(e=""+this.label+"...";e&&d.width+7>=this.diameter;)e=e.substr(0,e.length-4).concat("..."),"..."===e&&(e=!1),d=a.measureText(e);e&&(b=this.position.x-d.width/2,c=this.position.y+2,a.fillText(e,b,c))}return a.closePath()},a}()}.call(this),function(){BubbleChart.Point=function(){function a(a,b){this.x=a,this.y=b}return a.prototype.slope=function(a){var b,c;return b=this.y-a.y,c=this.x-a.x,b/c},a.prototype.angle=function(a){return 180*this.rAngle(a)/Math.PI+180},a.prototype.rAngle=function(a){return Math.atan2(this.y-a.y,this.x-a.x)},a.prototype.diff=function(a){return{x:this.x-a.x,y:this.y-a.y}},a.prototype.distance=function(a){var b;return b=this.diff(a),Math.sqrt(b.x*b.x+b.y*b.y)},a}()}.call(this),function(){BubbleChart.Pointer=function(){function a(){var a;this.current=null,this.bubble=null,this.diff=null,this.moving=!1,this.dragging=!1,a=this,this.e_move=function(){var b;return b=null,function(c){return clearTimeout(b),a.current=a.getPosition(c),a.moving=!0,a.grabbingBubble()&&(c.preventDefault(),a.dragging=!0),b=setTimeout(function(){return a.moving=!1},50)}}(),this.e_grab=function(b){return null!=a.bubble?(b.preventDefault(),a.bubble.grabbed=!0,a.diff=a.current.diff(a.bubble.position),a.current=null):void 0},this.e_release=function(b){return null!=a.bubble?(b.preventDefault(),a.bubble.grabbed=!1,a.diff=null,a.dragging||"undefined"!=typeof window&&null!==window&&null!=a.bubble.href&&(window.location.href=a.bubble.href),a.dragging=!1):void 0}}return a.prototype.grabbingBubble=function(){return null!=this.bubble&&this.bubble.grabbed},a.prototype.getPixelRatio=function(a){var b;return b=1,null!=window.devicePixelRatio&&a.context.webkitBackingStorePixelRatio<2&&(b=window.devicePixelRatio),b},a.prototype.getPosition=function(){var a,b;return b={},a={},function(c){var d,e,f,g,h;if(d=c.target||c.srcElement,e=d.id,f=this.getPixelRatio(d),null==b[e]||null==a[e])for(b[e]=0,a[e]=0;;)if(b[e]+=d.offsetTop||0,a[e]+=d.offsetLeft||0,d=d.offsetParent,!d)break;return c.touches&&c.touches.length>0?(g=c.touches[0].pageX-a[e],h=c.touches[0].pageY-b[e]):(g=c.pageX-a[e],h=c.pageY-b[e]),new BubbleChart.Point(g*f,h*f)}}(),a}()}.call(this),function(){BubbleChart.Popover=function(){function a(a,b){this.bubble=a,this.fillColor=b.fillColor||"#333",this.textColor=b.textColor||"#fff",this.textFont=b.textFont||"helvetica",this.opacity=b.opacity||.6,this.lineHeight=20}return a.prototype.paint=function(a,b){var c,d,e,f,g,h,i,j;if(null!=a.current)return b.font="17px '"+this.textFont+"'",g=b.measureText(this.bubble.label),i=b.measureText(""+this.bubble.data+" "+this.bubble.metric),h=g.width>i.width?g.width+15:i.width+15,e=a.current.x-14,f=a.current.y-26-2*this.lineHeight,j={x:0,y:0,x2:0,y2:0,x3:0,y3:0},0>f?(f=a.current.y+26,j.y=a.current.y+26,j.y3=j.y-4):(j.y=a.current.y-16,j.y3=a.current.y-10),j.x=a.current.x-8,j.x2=j.x+16,j.y2=j.y,j.x3=j.x2-8,e+h>b.canvas.width&&(e-=e+h-b.canvas.width),b.beginPath(),b.fillStyle=this.fillColor,b.globalAlpha=this.opacity,b.roundedRect(e,f,h,2*this.lineHeight+10,7),b.moveTo(j.x,j.y),b.lineTo(j.x2,j.y2),b.lineTo(j.x3,j.y3),b.lineTo(j.x,j.y),b.fill(),b.globalAlpha=1,b.fillStyle=this.textColor,b.fillText(this.bubble.label,e+7,f+this.lineHeight),b.font="11px "+this.textFont,c=e+7,d=f+2*this.lineHeight,b.fillText(""+this.bubble.data+" "+this.bubble.metric,c,d),b.closePath()},a}()}.call(this),function(){CanvasRenderingContext2D.prototype.roundedRect=function(a,b,c,d,e){return 2*e>c&&(e=c/2),2*e>d&&(e=d/2),this.moveTo(a+e,b),this.arcTo(a+c,b,a+c,b+d,e),this.arcTo(a+c,b+d,a,b+d,e),this.arcTo(a,b+d,a,b,e),this.arcTo(a,b,a+c,b,e)},Math.randInt=function(a){return null==a&&(a=100),Math.floor(Math.random()*a)}}.call(this);